<%

	@collection		||= collection																# Eg: @countries
	model					||= @collection.model.name.snake_case					# Eg: 'country'
	controller		||= model.to_s.plural.snake_case							# Eg: 'countries'

	model						= model.to_sym
	controller			= controller.to_sym

	single_label	||= model.to_s.gsub('_',' ')
	plural_label	||= controller.to_s.gsub('_',' ')
	
	index_filter		= params[:index_filter] || 'A'
		
	url_params		||= params[:url_params] || '{}'
	url_params			= CGI::unescape(url_params) if url_params =~ /^%7B/	# Check for escaped "{"
	url_params			= JSON.parse( url_params ) unless url_params.is_a? Hash
	url_params.merge!({ :url_params => url_params.to_json })

	title					||= "Organise the <em>#{ plural_label }</em> list"
	resource_new	||= resource( controller, :new, url_params )
	resource_edit	||= resource( controller, :new, url_params ).sub( '/new', '/{value}/edit' )	# TODO: Find less hacky way to achieve this!
	label_new			||= "add a new #{ single_label }..."
	label_edit		||= "#{ plural_label.capitalize }"

	name_attr			||= @collection.model.new.respond_to?(:display_name) ? :display_name : :name
	@collection			= @collection.all( :order => [ :order_by, :name ] ) if @collection.model.new.respond_to?(:order_by)

	filters          = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#+*'.chars.to_a			# Array of characters to filter by.
	filter_wildcards = { '#' => '0-9', '+' => 'Other', '*' => 'All' }	# How some characters should be displayed.
	relevant_filters = []

	@collection.map do |item|
		#item_char = 
		#relevant_filters << item.name.slice(1) if 
	end
	
	@collection			= @collection.all( :name.like => "#{ index_filter }%" ) if index_filter

-%>
<div class="sectionContainer">

	<%= section_head title %>

	<div id="sysAdminAjaxPanel" class="sectionBody formSurround">

		<% filters.each do |filter| -%><%=
			label = filter_wildcards[filter] || filter
			link_to label, resource( controller, :model => model, :index_filter => filter ), :class => 'filter-button'
		%><% end -%>

		<%= fields_for model do %>

			<% if !@collection.is_a?(Array) %>
				<%= select :id, :label => label_edit, :prompt => '- Choose one to modify', :rel => '.ajaxPanel', :href => resource_edit, :selected => '', :collection => @collection, :class => 'width2Fields height6Fields', :multiple => true %>
			<% else %>
				<%= select :id, :label => label_edit, :prompt => '- Choose one to modify', :rel => '.ajaxPanel', :href => resource_edit, :selected => '', :collection => @collection, :class => 'width2Fields height6Fields', :multiple => true, :value_method => :id, :text_method => name_attr %>
			<% end %>

		<%end =%>

		<br/>
		<%= link_to label_new, resource_new, :label => 'or', :class => 'new', :title => "Add a new #{ model } to this list" %>

	</div>

	<div class="sectionFoot formSurround"></div>
	
</div>